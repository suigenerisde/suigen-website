{
  "file_path": "src/lib/tracking/events.ts",
  "main_branch_history": [],
  "task_views": {
    "011-remove-or-conditionally-disable-console-logging-in": {
      "task_id": "011-remove-or-conditionally-disable-console-logging-in",
      "branch_point": {
        "commit_hash": "e327d25e2edeee628d7c36f91d94a613ea200851",
        "content": "import { supabase, isSupabaseConfigured } from '../supabase/client';\nimport type { EventType, Answer, FokusCheckResult, QuizStep } from '@/types/fokus-check';\n\n// n8n Webhook URLs\nconst N8N_WEBHOOK_URL = process.env.NEXT_PUBLIC_N8N_WEBHOOK_URL;\nconst N8N_CONTINUE_LATER_WEBHOOK = 'https://n8n.suimation.de/webhook/fokus-check-continue-later';\n\n// Session ID generieren (bleibt f\u00fcr die gesamte Session)\nconst generateSessionId = (): string => {\n  if (typeof window !== 'undefined') {\n    let sessionId = sessionStorage.getItem('fokus_check_session');\n    if (!sessionId) {\n      sessionId = crypto.randomUUID();\n      sessionStorage.setItem('fokus_check_session', sessionId);\n    }\n    return sessionId;\n  }\n  return crypto.randomUUID();\n};\n\nlet currentSessionId: string | null = null;\n\nexport const getSessionId = (): string => {\n  if (!currentSessionId) {\n    currentSessionId = generateSessionId();\n  }\n  return currentSessionId;\n};\n\n// Event tracking\nexport const trackEvent = async (\n  eventType: EventType,\n  eventData: Record<string, unknown> = {}\n): Promise<void> => {\n  if (!isSupabaseConfigured()) {\n    console.log('[Tracking disabled]', eventType, eventData);\n    return;\n  }\n\n  try {\n    const { error } = await supabase!.from('fokus_check_events').insert({\n      session_id: getSessionId(),\n      event_type: eventType,\n      event_data: eventData,\n    });\n\n    if (error) {\n      console.error('Tracking error:', error);\n    }\n  } catch (err) {\n    console.error('Tracking failed:', err);\n  }\n};\n\n// Spezifische Event-Funktionen\nexport const trackCheckStarted = () =>\n  trackEvent('check_started', {\n    timestamp: new Date().toISOString(),\n    userAgent: typeof window !== 'undefined' ? navigator.userAgent : undefined,\n  });\n\nexport const trackQuestionViewed = (questionId: number) =>\n  trackEvent('question_viewed', {\n    questionId,\n    timestamp: new Date().toISOString(),\n  });\n\nexport const trackQuestionAnswered = (\n  questionId: number,\n  value: number,\n  timeSpent: number\n) =>\n  trackEvent('question_answered', {\n    questionId,\n    value,\n    timeSpent,\n    timestamp: new Date().toISOString(),\n  });\n\nexport const trackCheckCompleted = (score: number, answers: Answer[]) =>\n  trackEvent('check_completed', {\n    score,\n    answers: answers.map((a) => ({\n      questionId: a.questionId,\n      value: a.value,\n      timeSpent: a.timeSpent,\n    })),\n    timestamp: new Date().toISOString(),\n  });\n\nexport const trackCheckAbandoned = (\n  lastQuestionId: number,\n  completedQuestions: number\n) =>\n  trackEvent('check_abandoned', {\n    lastQuestionId,\n    completedQuestions,\n    timestamp: new Date().toISOString(),\n  });\n\nexport const trackEmailSubmitted = (email: string, hasPhone: boolean = false) =>\n  trackEvent('email_submitted', {\n    emailDomain: email.split('@')[1],\n    hasPhone,\n    timestamp: new Date().toISOString(),\n  });\n\nexport const trackCtaClicked = (ctaType: string, destination: string) =>\n  trackEvent('cta_clicked', {\n    ctaType,\n    destination,\n    timestamp: new Date().toISOString(),\n  });\n\n// User erstellen/verkn\u00fcpfen\nexport const saveUserAndScore = async (\n  email: string,\n  score: number,\n  answers: Answer[],\n  phone?: string,\n  name?: string,\n  painPoint?: string\n): Promise<string | null> => {\n  if (!isSupabaseConfigured()) {\n    console.log('[Supabase disabled] Would save user:', email, score, phone, name, painPoint);\n    return null;\n  }\n\n  try {\n    // User erstellen oder updaten\n    const userData: Record<string, unknown> = {\n      email,\n      fokus_score: score,\n      answers: answers.map((a) => ({\n        questionId: a.questionId,\n        value: a.value,\n        timeSpent: a.timeSpent,\n      })),\n    };\n\n    // Telefonnummer nur hinzuf\u00fcgen wenn vorhanden\n    if (phone) {\n      userData.phone = phone;\n    }\n\n    // Name nur hinzuf\u00fcgen wenn vorhanden\n    if (name) {\n      userData.name = name;\n    }\n\n    // Pain Point als Metadaten speichern\n    if (painPoint) {\n      userData.pain_point = painPoint;\n    }\n\n    const { data, error } = await supabase!\n      .from('fokus_check_users')\n      .upsert(userData, { onConflict: 'email' })\n      .select('id')\n      .single();\n\n    if (error) {\n      console.error('Save user error:', {\n        message: error.message,\n        code: error.code,\n        details: error.details,\n        hint: error.hint,\n      });\n      return null;\n    }\n\n    // Events mit User verkn\u00fcpfen\n    if (data?.id) {\n      await supabase!\n        .from('fokus_check_events')\n        .update({ user_id: data.id })\n        .eq('session_id', getSessionId());\n    }\n\n    return data?.id || null;\n  } catch (err) {\n    console.error('Save user failed:', err);\n    return null;\n  }\n};\n\n// n8n Webhook f\u00fcr PDF-Generierung und WhatsApp-Versand triggern\nexport const triggerPdfAndWhatsApp = async (\n  email: string,\n  phone: string | undefined,\n  userName: string,\n  result: FokusCheckResult,\n  answers: Answer[],\n  painPoint?: string\n): Promise<boolean> => {\n  if (!N8N_WEBHOOK_URL) {\n    console.log('[n8n Webhook disabled] Would trigger PDF/WhatsApp:', { email, phone, userName, painPoint });\n    return false;\n  }\n\n  try {\n    const response = await fetch(N8N_WEBHOOK_URL, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        email,\n        phone: phone || null,\n        userName,\n        painPoint: painPoint || null,\n        result: {\n          score: result.score,\n          maxScore: result.maxScore,\n          category: result.category,\n          title: result.title,\n          description: result.description,\n        },\n        answers: answers.map((a) => ({\n          questionId: a.questionId,\n          value: a.value,\n          timeSpent: a.timeSpent,\n        })),\n        timestamp: new Date().toISOString(),\n      }),\n    });\n\n    if (!response.ok) {\n      console.error('n8n Webhook error:', response.status, await response.text());\n      return false;\n    }\n\n    const data = await response.json();\n    console.log('n8n Webhook success:', data);\n    return true;\n  } catch (err) {\n    console.error('n8n Webhook failed:', err);\n    return false;\n  }\n};\n\n// Progress State f\u00fcr \"Sp\u00e4ter weitermachen\"\ninterface ProgressState {\n  step: QuizStep;\n  userName: string;\n  currentQuestion: number;\n  answers: Answer[];\n}\n\n// Fortschritt in Supabase speichern und Magic Link senden\nexport const saveProgressAndSendLink = async (\n  state: ProgressState,\n  contact: { email?: string; phone?: string }\n): Promise<{ success: boolean; token?: string }> => {\n  if (!isSupabaseConfigured()) {\n    console.log('[Supabase disabled] Would save progress:', state, contact);\n    return { success: false };\n  }\n\n  try {\n    // Generiere eindeutigen Token\n    const token = crypto.randomUUID();\n\n    // State f\u00fcr Supabase vorbereiten (Dates zu Strings)\n    const stateForDb = {\n      step: state.step,\n      userName: state.userName,\n      currentQuestion: state.currentQuestion,\n      answers: state.answers.map((a) => ({\n        questionId: a.questionId,\n        value: a.value,\n        timeSpent: a.timeSpent,\n        answeredAt: a.answeredAt instanceof Date ? a.answeredAt.toISOString() : a.answeredAt,\n        followUp: a.followUp,\n      })),\n    };\n\n    // In Supabase speichern\n    const { error } = await supabase!.from('fokus_check_progress').insert({\n      token,\n      state: stateForDb,\n      email: contact.email || null,\n      phone: contact.phone || null,\n      expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 Tage\n    });\n\n    if (error) {\n      console.error('Save progress error:', error);\n      return { success: false };\n    }\n\n    // n8n Webhook f\u00fcr Link-Versand triggern\n    try {\n      const response = await fetch(N8N_CONTINUE_LATER_WEBHOOK, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          token,\n          email: contact.email || null,\n          phone: contact.phone || null,\n          userName: state.userName,\n          currentQuestion: state.currentQuestion + 1,\n          totalQuestions: 8,\n          continueUrl: `https://suigen.de/fokus-check?continue=${token}`,\n          timestamp: new Date().toISOString(),\n        }),\n      });\n\n      if (!response.ok) {\n        console.error('Continue-later webhook error:', response.status);\n      }\n    } catch (webhookErr) {\n      console.error('Continue-later webhook failed:', webhookErr);\n      // Nicht als Fehler behandeln - der Link ist trotzdem gespeichert\n    }\n\n    return { success: true, token };\n  } catch (err) {\n    console.error('Save progress failed:', err);\n    return { success: false };\n  }\n};\n\n// Fortschritt aus Supabase laden\nexport const loadProgress = async (\n  token: string\n): Promise<{ success: boolean; state?: ProgressState }> => {\n  if (!isSupabaseConfigured()) {\n    console.log('[Supabase disabled] Would load progress for token:', token);\n    return { success: false };\n  }\n\n  try {\n    const { data, error } = await supabase!\n      .from('fokus_check_progress')\n      .select('state, expires_at')\n      .eq('token', token)\n      .single();\n\n    if (error || !data) {\n      console.error('Load progress error:', error);\n      return { success: false };\n    }\n\n    // Pr\u00fcfen ob abgelaufen\n    if (new Date(data.expires_at) < new Date()) {\n      console.log('Progress token expired');\n      return { success: false };\n    }\n\n    // State rekonstruieren\n    const state = data.state as ProgressState;\n\n    // Dates zur\u00fcck konvertieren\n    state.answers = state.answers.map((a) => ({\n      ...a,\n      answeredAt: new Date(a.answeredAt as unknown as string),\n    }));\n\n    return { success: true, state };\n  } catch (err) {\n    console.error('Load progress failed:', err);\n    return { success: false };\n  }\n};\n\n// Fortschritt l\u00f6schen (nach erfolgreichem Abschluss)\nexport const deleteProgress = async (token: string): Promise<void> => {\n  if (!isSupabaseConfigured()) return;\n\n  try {\n    await supabase!.from('fokus_check_progress').delete().eq('token', token);\n  } catch (err) {\n    console.error('Delete progress failed:', err);\n  }\n};\n",
        "timestamp": "2025-12-28T13:46:12.464327"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "011-remove-or-conditionally-disable-console-logging-in",
        "description": "Create a centralized logging utility that conditionally disables console output in production, replace all 31 console.log/error/warn statements across 7 source files with the logger utility.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-28T13:38:23.769078",
  "last_updated": "2025-12-28T13:46:12.516823"
}
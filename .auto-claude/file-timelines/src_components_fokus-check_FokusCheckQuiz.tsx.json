{
  "file_path": "src/components/fokus-check/FokusCheckQuiz.tsx",
  "main_branch_history": [],
  "task_views": {
    "011-remove-or-conditionally-disable-console-logging-in": {
      "task_id": "011-remove-or-conditionally-disable-console-logging-in",
      "branch_point": {
        "commit_hash": "e327d25e2edeee628d7c36f91d94a613ea200851",
        "content": "'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport type { Answer, QuizStep, FokusCheckResult, DeliveryData, FollowUpAnswer, AccessRequestData } from '@/types/fokus-check';\nimport { questions, MAX_SCORE, getResultCategory } from './questions-data';\nimport { ProgressIndicator } from './ProgressIndicator';\nimport { QuestionCard } from './QuestionCard';\nimport { NameCapture } from './NameCapture';\nimport { DeliveryChoice } from './DeliveryChoice';\nimport { ResultDisplay } from './ResultDisplay';\nimport { ExitIntentPopup } from './ExitIntentPopup';\nimport { FollowUpQuestion } from './FollowUpQuestion';\nimport { PainPointQuestion } from './PainPointQuestion';\nimport { ContinueQuizPrompt } from './ContinueQuizPrompt';\nimport { InviteCodeCapture } from './InviteCodeCapture';\nimport { AccessRequestForm } from './AccessRequestForm';\nimport { useQuizPersistence } from './useQuizPersistence';\nimport { Button } from '@/components/ui/Button';\nimport {\n  trackCheckStarted,\n  trackQuestionViewed,\n  trackQuestionAnswered,\n  trackCheckCompleted,\n  trackEmailSubmitted,\n  trackCtaClicked,\n  saveUserAndScore,\n  triggerPdfAndWhatsApp,\n  saveProgressAndSendLink,\n  loadProgress,\n  deleteProgress,\n} from '@/lib/tracking/events';\nimport { ContinueLaterModal } from './ContinueLaterModal';\nimport { useSearchParams } from 'next/navigation';\n\n// Webhook URL f\u00fcr Zugangsanfragen\nconst ACCESS_REQUEST_WEBHOOK = 'https://n8n.suimation.de/webhook/fokus-check-access-request';\n\nexport function FokusCheckQuiz() {\n  const [step, setStep] = useState<QuizStep>('invite-code');\n  const [userName, setUserName] = useState('');\n  const [currentQuestion, setCurrentQuestion] = useState(0);\n  const [answers, setAnswers] = useState<Answer[]>([]);\n  const [questionStartTime, setQuestionStartTime] = useState<Date | null>(null);\n  const [isLoading, setIsLoading] = useState(false);\n  const [result, setResult] = useState<FokusCheckResult | null>(null);\n  const [showFollowUp, setShowFollowUp] = useState(false);\n  const [pendingAnswer, setPendingAnswer] = useState<Answer | null>(null);\n  const [showContinuePrompt, setShowContinuePrompt] = useState(false);\n  const [painPoint, setPainPoint] = useState('');\n  const [showContinueLaterModal, setShowContinueLaterModal] = useState(false);\n  const [continueToken, setContinueToken] = useState<string | null>(null);\n\n  // URL Parameter f\u00fcr Magic Link\n  const searchParams = useSearchParams();\n  const [isLoadingFromToken, setIsLoadingFromToken] = useState(false);\n\n  // Check for continue token in URL on mount\n  useEffect(() => {\n    const token = searchParams.get('continue');\n    if (token) {\n      setContinueToken(token);\n      setIsLoadingFromToken(true);\n\n      loadProgress(token).then(({ success, state }) => {\n        if (success && state) {\n          // Restore state from Supabase\n          setStep(state.step);\n          setUserName(state.userName);\n          setCurrentQuestion(state.currentQuestion);\n          setAnswers(state.answers);\n          // Don't show localStorage continue prompt\n          setShowContinuePrompt(false);\n        }\n        setIsLoadingFromToken(false);\n      }).catch((err) => {\n        console.error('Error loading progress from token:', err);\n        setIsLoadingFromToken(false);\n      });\n    }\n  }, [searchParams]);\n\n  // Persistence hook\n  const { restoredState, saveProgress, clearProgress, dismissRestoredState } = useQuizPersistence();\n\n  // Check for saved progress on mount\n  useEffect(() => {\n    if (restoredState && restoredState.step !== 'intro' && restoredState.step !== 'result') {\n      setShowContinuePrompt(true);\n    }\n  }, [restoredState]);\n\n  // Save progress whenever state changes (but only during active quiz)\n  useEffect(() => {\n    if (step !== 'intro' && step !== 'result') {\n      saveProgress({\n        step,\n        userName,\n        currentQuestion,\n        answers,\n      });\n    }\n  }, [step, userName, currentQuestion, answers, saveProgress]);\n\n  // Track question view\n  useEffect(() => {\n    if (step === 'questions' && currentQuestion < questions.length) {\n      trackQuestionViewed(questions[currentQuestion].id);\n      setQuestionStartTime(new Date());\n    }\n  }, [step, currentQuestion]);\n\n  // Handle continuing from saved progress\n  const handleContinue = useCallback(() => {\n    if (restoredState) {\n      setStep(restoredState.step);\n      setUserName(restoredState.userName);\n      setCurrentQuestion(restoredState.currentQuestion);\n      setAnswers(restoredState.answers);\n      setShowContinuePrompt(false);\n      dismissRestoredState();\n    }\n  }, [restoredState, dismissRestoredState]);\n\n  // Handle starting fresh\n  const handleStartFresh = useCallback(() => {\n    clearProgress();\n    setShowContinuePrompt(false);\n    dismissRestoredState();\n    setStep('intro');\n    setUserName('');\n    setCurrentQuestion(0);\n    setAnswers([]);\n  }, [clearProgress, dismissRestoredState]);\n\n  // Handle valid invite code\n  const handleValidCode = useCallback(() => {\n    setStep('intro');\n  }, []);\n\n  // Handle request access (show form)\n  const handleRequestAccess = useCallback(() => {\n    setStep('access-request');\n  }, []);\n\n  // Handle back to invite code\n  const handleBackToInviteCode = useCallback(() => {\n    setStep('invite-code');\n  }, []);\n\n  // Handle access request submission\n  const handleAccessRequestSubmit = useCallback(async (data: AccessRequestData) => {\n    // Trigger n8n webhook f\u00fcr WhatsApp-Benachrichtigung\n    const response = await fetch(ACCESS_REQUEST_WEBHOOK, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        name: data.name,\n        email: data.email,\n        phone: data.phone,\n        requestedAt: new Date().toISOString(),\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error('Failed to submit access request');\n    }\n  }, []);\n\n  const handleStart = useCallback(() => {\n    trackCheckStarted();\n    setStep('name');\n  }, []);\n\n  const handleNameSubmit = useCallback((name: string) => {\n    setUserName(name);\n    setStep('questions');\n  }, []);\n\n  const handleAnswer = useCallback(\n    (value: number) => {\n      const timeSpent = questionStartTime\n        ? Math.round((new Date().getTime() - questionStartTime.getTime()) / 1000)\n        : 0;\n\n      const answer: Answer = {\n        questionId: questions[currentQuestion].id,\n        value,\n        answeredAt: new Date(),\n        timeSpent,\n      };\n\n      trackQuestionAnswered(answer.questionId, value, timeSpent);\n\n      // Check if follow-up is triggered\n      const currentQ = questions[currentQuestion];\n      if (currentQ.followUp && currentQ.followUp.triggerValues.includes(value)) {\n        // Show follow-up, store answer temporarily\n        setPendingAnswer(answer);\n        setShowFollowUp(true);\n        return;\n      }\n\n      // No follow-up - proceed normally\n      proceedWithAnswer(answer);\n    },\n    [currentQuestion, questionStartTime]\n  );\n\n  const proceedWithAnswer = useCallback(\n    (answer: Answer) => {\n      const newAnswers = [...answers, answer];\n      setAnswers(newAnswers);\n\n      if (currentQuestion < questions.length - 1) {\n        setCurrentQuestion(currentQuestion + 1);\n      } else {\n        // All questions answered - go to pain point question\n        const score = newAnswers.reduce((sum, a) => sum + a.value, 0);\n        const category = getResultCategory(score);\n\n        setResult({\n          score,\n          maxScore: MAX_SCORE,\n          ...category,\n        });\n\n        trackCheckCompleted(score, newAnswers);\n        setStep('painpoint');\n      }\n    },\n    [currentQuestion, answers]\n  );\n\n  const handleFollowUpSubmit = useCallback(\n    (followUpAnswer: FollowUpAnswer) => {\n      if (pendingAnswer) {\n        // Add follow-up answer to main answer\n        const answerWithFollowUp: Answer = {\n          ...pendingAnswer,\n          followUp: followUpAnswer,\n        };\n        setShowFollowUp(false);\n        setPendingAnswer(null);\n        proceedWithAnswer(answerWithFollowUp);\n      }\n    },\n    [pendingAnswer, proceedWithAnswer]\n  );\n\n  const handleFollowUpSkip = useCallback(() => {\n    if (pendingAnswer) {\n      // Continue without follow-up\n      setShowFollowUp(false);\n      setPendingAnswer(null);\n      proceedWithAnswer(pendingAnswer);\n    }\n  }, [pendingAnswer, proceedWithAnswer]);\n\n  const handlePainPointSubmit = useCallback((text: string) => {\n    setPainPoint(text);\n    setStep('email');\n  }, []);\n\n  const handlePainPointSkip = useCallback(() => {\n    setPainPoint('');\n    setStep('email');\n  }, []);\n\n  const handleBack = useCallback(() => {\n    if (currentQuestion > 0) {\n      setCurrentQuestion(currentQuestion - 1);\n      // Remove last answer\n      setAnswers(answers.slice(0, -1));\n    } else {\n      // Back to name input\n      setStep('name');\n    }\n  }, [currentQuestion, answers]);\n\n  const handleDeliverySubmit = useCallback(\n    async (data: DeliveryData) => {\n      setIsLoading(true);\n\n      try {\n        trackEmailSubmitted(data.email, !!data.phone);\n\n        if (result) {\n          // Save user to Supabase (painPoint wird als Teil der answers/metadata gespeichert)\n          await saveUserAndScore(data.email, result.score, answers, data.phone, userName, painPoint);\n\n          // Trigger n8n workflow for PDF + WhatsApp\n          // Runs asynchronously in background - we don't wait for it\n          triggerPdfAndWhatsApp(data.email, data.phone, userName, result, answers, painPoint)\n            .then((success) => {\n              if (success) {\n                console.log('PDF/WhatsApp workflow triggered successfully');\n              }\n            })\n            .catch((err) => {\n              console.error('PDF/WhatsApp workflow error:', err);\n            });\n        }\n\n        // Clear saved progress on completion\n        clearProgress();\n        // Also delete server-side progress if continued from token\n        if (continueToken) {\n          deleteProgress(continueToken);\n        }\n        setStep('result');\n      } catch (error) {\n        console.error('Error saving user:', error);\n        // Still show result even on error\n        clearProgress();\n        setStep('result');\n      } finally {\n        setIsLoading(false);\n      }\n    },\n    [result, answers, userName, painPoint, clearProgress]\n  );\n\n  const handleCtaClick = useCallback(() => {\n    trackCtaClicked('erstgespraech', '/kontakt');\n  }, []);\n\n  // Save and leave callback for ExitIntentPopup - now opens modal instead\n  const handleSaveAndLeave = useCallback(() => {\n    // Show the continue later modal instead of just saving to localStorage\n    setShowContinueLaterModal(true);\n  }, []);\n\n  // Handler for ContinueLaterModal submission\n  const handleContinueLaterSubmit = useCallback(async (data: { email?: string; phone?: string }) => {\n    const { success, token } = await saveProgressAndSendLink(\n      { step, userName, currentQuestion, answers },\n      data\n    );\n\n    if (!success) {\n      throw new Error('Failed to save progress');\n    }\n\n    // Also save to localStorage as backup\n    saveProgress({ step, userName, currentQuestion, answers });\n\n    return;\n  }, [step, userName, currentQuestion, answers, saveProgress]);\n\n  // Handler to close ContinueLaterModal\n  const handleCloseContinueLaterModal = useCallback(() => {\n    setShowContinueLaterModal(false);\n  }, []);\n\n  // Show loading state when loading from continue token\n  if (isLoadingFromToken) {\n    return (\n      <div className=\"w-full max-w-xl mx-auto\">\n        <div className=\"animate-fade-in text-center py-16\">\n          <div className=\"w-16 h-16 mx-auto mb-6 rounded-full bg-[var(--accent)]/10 flex items-center justify-center animate-pulse\">\n            <svg className=\"w-8 h-8 text-[var(--accent)]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n            </svg>\n          </div>\n          <h2 className=\"text-2xl font-bold text-[var(--text-light)] mb-2\">\n            Deinen Fortschritt laden...\n          </h2>\n          <p className=\"text-[var(--text-muted)]\">\n            Einen Moment bitte.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Show continue prompt if saved progress exists\n  if (showContinuePrompt && restoredState) {\n    return (\n      <div className=\"w-full max-w-xl mx-auto\">\n        <ContinueQuizPrompt\n          questionNumber={restoredState.currentQuestion + 1}\n          totalQuestions={questions.length}\n          userName={restoredState.userName}\n          onContinue={handleContinue}\n          onStartFresh={handleStartFresh}\n        />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full max-w-xl mx-auto\">\n      {/* Invite Code */}\n      {step === 'invite-code' && (\n        <InviteCodeCapture\n          onValidCode={handleValidCode}\n          onRequestAccess={handleRequestAccess}\n        />\n      )}\n\n      {/* Access Request Form */}\n      {step === 'access-request' && (\n        <AccessRequestForm\n          onSubmit={handleAccessRequestSubmit}\n          onBack={handleBackToInviteCode}\n        />\n      )}\n\n      {/* Intro */}\n      {step === 'intro' && (\n        <div className=\"animate-fade-in\">\n          <span className=\"inline-block px-4 py-2 bg-[var(--accent)]/10 text-[var(--accent)] text-sm font-bold rounded uppercase tracking-widest mb-8 border border-[var(--accent)]/20\">\n            Dein Fokus-Score\n          </span>\n\n          <h1 className=\"headline-hero text-[var(--text-light)] mb-6\">\n            Wie fokussiert\n            <br />\n            <span className=\"text-[var(--accent)] text-glow\">bist Du wirklich?</span>\n          </h1>\n\n          <p className=\"body-text mb-8 max-w-2xl\">\n            Finde in 3 Minuten heraus, wie gut Du Dich auf das Wesentliche konzentrierst.\n            8 Fragen, sofort Ergebnis.\n          </p>\n\n          <Button onClick={handleStart} variant=\"primary\" size=\"lg\">\n            Meinen Fokus-Score berechnen\n          </Button>\n\n          {/* WhatsApp Bonus Teaser */}\n          <div className=\"mt-6 bg-gradient-to-r from-[var(--accent)]/10 to-transparent border-l-4 border-[var(--accent)] p-4 rounded-r-lg\">\n            <p className=\"text-[var(--text-light)] font-medium flex items-center gap-2\">\n              <span className=\"text-lg\">\ud83c\udf81</span>\n              Bonus: Detaillierter PDF-Report per WhatsApp\n            </p>\n            <p className=\"text-[var(--text-muted)] text-sm mt-1\">\n              Mit pers\u00f6nlicher Analyse und konkreten Handlungsempfehlungen\n            </p>\n          </div>\n\n          <div className=\"flex flex-wrap gap-4 md:gap-6 mt-8 text-[var(--text-muted)] text-sm\">\n            <span className=\"flex items-center gap-2\">\n              <svg\n                className=\"w-4 h-4 text-[var(--accent)]\"\n                fill=\"currentColor\"\n                viewBox=\"0 0 20 20\"\n              >\n                <path\n                  fillRule=\"evenodd\"\n                  d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\"\n                  clipRule=\"evenodd\"\n                />\n              </svg>\n              8 Fragen\n            </span>\n            <span className=\"flex items-center gap-2\">\n              <svg\n                className=\"w-4 h-4 text-[var(--accent)]\"\n                fill=\"currentColor\"\n                viewBox=\"0 0 20 20\"\n              >\n                <path\n                  fillRule=\"evenodd\"\n                  d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\"\n                  clipRule=\"evenodd\"\n                />\n              </svg>\n              3 Minuten\n            </span>\n            <span className=\"flex items-center gap-2\">\n              <svg\n                className=\"w-4 h-4 text-[var(--accent)]\"\n                fill=\"currentColor\"\n                viewBox=\"0 0 20 20\"\n              >\n                <path\n                  fillRule=\"evenodd\"\n                  d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\"\n                  clipRule=\"evenodd\"\n                />\n              </svg>\n              Sofort Ergebnis\n            </span>\n            <span className=\"flex items-center gap-2\">\n              <svg\n                className=\"w-4 h-4 text-[var(--accent)]\"\n                fill=\"currentColor\"\n                viewBox=\"0 0 20 20\"\n              >\n                <path\n                  fillRule=\"evenodd\"\n                  d=\"M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z\"\n                  clipRule=\"evenodd\"\n                />\n              </svg>\n              100% kostenlos\n            </span>\n          </div>\n        </div>\n      )}\n\n      {/* Name Capture */}\n      {step === 'name' && (\n        <NameCapture onSubmit={handleNameSubmit} />\n      )}\n\n      {/* Questions */}\n      {step === 'questions' && !showFollowUp && (\n        <div>\n          <ProgressIndicator\n            current={currentQuestion}\n            total={questions.length}\n          />\n          <QuestionCard\n            key={currentQuestion}\n            question={questions[currentQuestion]}\n            questionNumber={currentQuestion + 1}\n            totalQuestions={questions.length}\n            onAnswer={handleAnswer}\n          />\n\n          {/* Back Button */}\n          <button\n            onClick={handleBack}\n            className=\"mt-8 flex items-center gap-2 text-[var(--text-muted)] hover:text-[var(--text-light)] transition-colors mx-auto\"\n          >\n            <svg\n              className=\"w-4 h-4\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M15 19l-7-7 7-7\"\n              />\n            </svg>\n            Zur\u00fcck\n          </button>\n        </div>\n      )}\n\n      {/* Follow-up Question */}\n      {step === 'questions' && showFollowUp && questions[currentQuestion].followUp && (\n        <div>\n          <ProgressIndicator\n            current={currentQuestion}\n            total={questions.length}\n          />\n          <FollowUpQuestion\n            question={questions[currentQuestion].followUp!.question}\n            parentQuestionId={questions[currentQuestion].id}\n            onSubmit={handleFollowUpSubmit}\n            onSkip={handleFollowUpSkip}\n          />\n        </div>\n      )}\n\n      {/* Pain Point Question */}\n      {step === 'painpoint' && (\n        <PainPointQuestion\n          userName={userName}\n          onSubmit={handlePainPointSubmit}\n          onSkip={handlePainPointSkip}\n        />\n      )}\n\n      {/* Delivery Choice (E-Mail + optional Phone) */}\n      {step === 'email' && (\n        <DeliveryChoice onSubmit={handleDeliverySubmit} isLoading={isLoading} />\n      )}\n\n      {/* Result */}\n      {step === 'result' && result && (\n        <ResultDisplay result={result} userName={userName} answers={answers} onCtaClick={handleCtaClick} />\n      )}\n\n      {/* Exit Intent Popup */}\n      <ExitIntentPopup\n        onContinue={step === 'intro' ? handleStart : () => {}}\n        currentStep={step}\n        questionNumber={currentQuestion + 1}\n        onSaveAndLeave={handleSaveAndLeave}\n      />\n\n      {/* Continue Later Modal */}\n      <ContinueLaterModal\n        isOpen={showContinueLaterModal}\n        onClose={handleCloseContinueLaterModal}\n        onSubmit={handleContinueLaterSubmit}\n        userName={userName}\n        questionNumber={currentQuestion + 1}\n        totalQuestions={questions.length}\n      />\n    </div>\n  );\n}\n",
        "timestamp": "2025-12-28T13:46:12.464327"
      },
      "worktree_state": null,
      "task_intent": {
        "title": "011-remove-or-conditionally-disable-console-logging-in",
        "description": "Create a centralized logging utility that conditionally disables console output in production, replace all 31 console.log/error/warn statements across 7 source files with the logger utility.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-28T13:38:23.619894",
  "last_updated": "2025-12-28T13:46:12.582565"
}